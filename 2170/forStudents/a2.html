<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coffee Faceted Search Designer – Single File</title>
<style>
  :root { --bg:#0b0e14; --card:#11151d; --ink:#e6edf3; --muted:#9aa4b2; --line:#232a36; --acc:#6ee7ff; }
  *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink)}
  header,main{max-width:1200px;margin:auto;padding:16px}
  h1{font-size:20px;margin:0 0 8px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:var(--card);cursor:pointer}
  .tab[aria-selected="true"]{outline:2px solid var(--acc)}
  .panel{display:none}
  .panel[aria-hidden="false"]{display:block}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  label{display:block;margin-bottom:6px;color:var(--muted)}
  input[type="text"], input[type="number"], textarea, select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#0d1117;color:var(--ink)}
  textarea{min-height:180px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
  button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0d1117;color:var(--ink);cursor:pointer}
  button.primary{background:#0e7490;border-color:#0e7490}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--ink);background:#0d1117;margin:2px}
  .muted{color:var(--muted)}
  .sticky{position:sticky;top:12px}
  .list{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px;color:var(--muted)}
  .sep{height:1px;background:var(--line);margin:8px 0}
  .opt{display:flex;align-items:center;gap:6px;margin:4px 0}
  /* small screen */ @media (max-width: 760px){ .g2,.g3{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>Coffee Faceted Search Designer (Single‑File, No Build)</h1>
  <div class="muted">Paste a CSV, map labels, add facets, and preview search. Everything runs in the browser.</div>
</header>
<main>
  <div class="tabs" role="tablist" aria-label="Steps">
    <button class="tab" role="tab" id="t-data" aria-controls="p-data" aria-selected="true">1. Data</button>
    <button class="tab" role="tab" id="t-labels" aria-controls="p-labels" aria-selected="false">2. Labels</button>
    <button class="tab" role="tab" id="t-facets" aria-controls="p-facets" aria-selected="false">3. Facets</button>
    <button class="tab" role="tab" id="t-preview" aria-controls="p-preview" aria-selected="false">4. Preview</button>
  </div>

  <!-- Panels -->
  <section id="p-data" class="panel" role="tabpanel" aria-labelledby="t-data" aria-hidden="false">
    <div class="card grid g2">
      <div>
        <label for="csv">Paste CSV</label>
        <textarea id="csv"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="load" class="primary">Load</button>
          <button id="sample">Reset to sample</button>
        </div>
      </div>
      <div>
        <label>Upload CSV</label>
        <input type="file" id="file" accept=".csv" />
        <div class="sep"></div>
        <div id="cols" class="muted">Columns detected: none</div>
      </div>
    </div>
  </section>

  <section id="p-labels" class="panel" role="tabpanel" aria-labelledby="t-labels" aria-hidden="true">
    <div class="card grid g3">
      <div>
        <label>Primary title</label>
        <select id="titleCol"></select>
      </div>
      <div>
        <label>Price (optional)</label>
        <select id="priceCol"></select>
      </div>
      <div>
        <label>Primary Navigation</label>
        <div class="grid g2">
          <div>
            <label for="navCol">Nav column</label>
            <select id="navCol"></select>
          </div>
          <div>
            <label for="navAll">Show "All" tab</label>
            <div class="row"><input type="checkbox" id="navAll" checked><span class="muted">Include All</span></div>
          </div>
        </div>
        <div class="muted">Values of this column render as a top nav; clicking also filters results.</div>
      </div>
    </div>
    <div class="grid g2" style="margin-top:12px">
      <div class="card">
        <label>Subtitles (beneath title)</label>
        <div id="subtitleWrap"></div>
        <button id="addSubtitle">Add subtitle</button>
      </div>
      <div class="card">
        <label>Badges (small labels)</label>
        <div id="badgeWrap"></div>
        <button id="addBadge">Add badge</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <label>Secondary metadata (small print on cards)</label>
      <div id="secondaryWrap"></div>
      <button id="addSecondary">Add secondary</button>
    </div>
  </section>

  <section id="p-facets" class="panel" role="tabpanel" aria-labelledby="t-facets" aria-hidden="true">
    <div id="facetList" class="grid" style="gap:12px"></div>
    <div style="margin-top:8px"><button id="addFacet" class="primary">Add facet</button></div>
  </section>

  <section id="p-preview" class="panel" role="tabpanel" aria-labelledby="t-preview" aria-hidden="true">
    <div class="grid g2">
      <aside class="card sticky">
        <div>
          <label>Primary search</label>
          <input type="text" id="q" placeholder="Search name, origin, notes…" />
        </div>
        <div class="sep"></div>
        <div id="filters"></div>
        <div class="sep"></div>
        <button id="clear">Clear all</button>
      </aside>
      <section>
        <div id="navBar" class="row" style="flex-wrap:wrap;margin:0 0 8px"></div>
        <div class="row muted" style="justify-content:space-between;margin:6px 0 12px">
          <div id="count">0 of 0 coffees</div>
          <div class="row"><button id="exportMermaid">Export Mermaid</button></div>
        </div>
        <div class="list" id="results"></div>
        <div id="mermaidWrap" class="card" style="display:none; margin-top:12px">
          <label>Mermaid diagram (copy into Markdown that supports Mermaid)</label>
          <textarea id="mermaidText"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="hideMermaid">Hide</button>
            <button id="downloadMermaid">Download .md</button>
          </div>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- Papaparse CDN -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function(){
  // ---------- State ----------
  let rows = [];
  let columns = [];
  const config = {
    primary: { titleCol: undefined, priceCol: undefined, subtitleCols: [], badgeCols: [] },
    secondaryCols: [],
    nav: { column: undefined, showAll: true },
    facets: [] // {id, col, label, type, tokenizeBy}
  };
  const facetState = {}; // id -> value
  let activeNavValue = null; // top-nav selection // id -> value

  // ---------- Sample CSV ----------
  const sampleCSV = `Coffee ID,Name,Origin (Country),Altitude (m),Cultivar/Varietal,Processing Method,Harvest Year,Certification,Flavor Profile,Acidity,Roast Level,Recommended Brewing Method,Recommended Brewing Method 2,Size,Availability,Price\n101,El Paraiso Washed,Colombia,1800,Caturra,Washed,2024,Organic,"chocolate, citrus",Medium,Medium,Pour-over,Drip,250g,In stock,18.50\n102,Nyeri PB,Kenya,1900,SL28; SL34,Washed,2024,,"blackcurrant, grapefruit",High,Light,Pour-over,Aeropress,340g,In stock,22.00\n103,Ethiopia Guji Natural,Ethiopia,2100,Heirloom,Natural,2023,Fairtrade,"blueberry, jasmine",High,Light,Pour-over,Espresso,250g,Pre-order,19.00\n104,Sidamo Decaf,Ethiopia,1800,Bourbon,Swiss Water Decaf,2023,Organic,"cocoa, almond",Low,Medium,Drip,French Press,340g,In stock,17.00\n105,Sul de Minas Pulped Natural,Brazil,1200,Yellow Catuai,Pulped Natural,2024,Rainforest,"peanut, caramel",Low,Medium-Dark,Espresso,Drip,1000g,In stock,25.00\n106,Peaberry Peñas Blancas,Costa Rica,1600,Typica,White Honey,2024,,"stone fruit, vanilla",Medium,Light,Pour-over,Cold Brew,250g,In stock,16.50\n107,Sumatra Gayo,Indonesia,1400,Catimor,Wet-Hulled,2023,,"earthy, cedar",Low,Dark,Espresso,French Press,340g,In stock,20.00\n108,Antigua SHB,Guatemala,1700,Bourbon,Washed,2024,,"toffee, apple",Medium,Medium,Pour-over,Drip,250g,Out of stock,15.50`;

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  function el(tag, attrs={}, children=[]) {
    const node = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') node.className = v; else if (k === 'for') node.htmlFor = v; else node.setAttribute(k, v);
    }
    for (const c of children) node.append(c);
    return node;
  }
  function parseCSV(text){
    const res = Papa.parse(text.trim(), { header: true, skipEmptyLines: true });
    const rs = res.data.map(r => Object.fromEntries(Object.entries(r).map(([k,v]) => [k.trim(), (typeof v === 'string' ? v.trim() : v)])));
    const cols = res.meta.fields || (rs[0] ? Object.keys(rs[0]) : []);
    return { rows: rs, columns: cols };
  }
  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean).map(String))).sort((a,b)=>a.localeCompare(b)); }
  function coerceNumber(v){ if (v==null) return null; const n = Number(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:n; }

  // ---------- Tabs (no unmount state loss) ----------
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const panels = Array.from(document.querySelectorAll('.panel'));
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.setAttribute('aria-selected', x===t ? 'true':'false'));
    panels.forEach(p => p.setAttribute('aria-hidden', p.id === t.getAttribute('aria-controls') ? 'false':'true'));
  }));

  // ---------- Data panel ----------
  $('#csv').value = sampleCSV;
  $('#sample').addEventListener('click', ()=>{ $('#csv').value = sampleCSV; });
  $('#file').addEventListener('change', e => {
    const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = () => { $('#csv').value = String(r.result) }; r.readAsText(f);
  });
  $('#load').addEventListener('click', () => {
    const parsed = parseCSV($('#csv').value);
    rows = parsed.rows; columns = parsed.columns;
    $('#cols').textContent = 'Columns detected: ' + (columns.length? columns.join(', '): 'none');
    // init sensible defaults
    config.primary.titleCol = columns.includes('Name') ? 'Name' : columns[0];
    if (columns.includes('Price')) config.primary.priceCol = 'Price';
    config.primary.subtitleCols = ['Origin (Country)','Cultivar/Varietal'].filter(c=>columns.includes(c));
    config.primary.badgeCols = ['Certification'].filter(c=>columns.includes(c));
    config.secondaryCols = ['Roast Level','Acidity','Processing Method'].filter(c=>columns.includes(c));
    // seed facets if none
    if (!config.facets.length) {
      if (columns.includes('Origin (Country)')) config.facets.push({ id: crypto.randomUUID(), col:'Origin (Country)', label:'Origin', type:'multi' });
      if (columns.includes('Roast Level')) config.facets.push({ id: crypto.randomUUID(), col:'Roast Level', label:'Roast', type:'multi' });
      if (columns.includes('Altitude (m)')) config.facets.push({ id: crypto.randomUUID(), col:'Altitude (m)', label:'Altitude (m)', type:'range' });
      if (columns.includes('Flavor Profile')) config.facets.push({ id: crypto.randomUUID(), col:'Flavor Profile', label:'Flavor notes', type:'tokens', tokenizeBy:',' });
      if (columns.includes('Price')) config.facets.push({ id: crypto.randomUUID(), col:'Price', label:'Price', type:'range' });
    }
    renderLabels(); renderFacets(); renderPreview();
  });

  // ---------- Labels panel ----------
  function optionsForColumns(sel, allowBlank=false){
    sel.innerHTML = '';
    if (allowBlank) sel.append(el('option', {value:''}, ['—']));
    for (const c of columns) sel.append(el('option', {value:c}, [c]));
  }
  function renderListPicker(container, list){
    container.innerHTML = '';
    const row = el('div', {class:'row'});
    const add = el('select'); optionsForColumns(add, true); add.value='';
    const btn = el('button', {}, ['Add']);
    btn.addEventListener('click', () => { if(add.value){ list.push(add.value); renderLabels(); renderPreview(); }});
    container.append(row, add, btn);
    // chips
    const chips = el('div');
    for (const [idx, c] of list.entries()) {
      const chip = el('span', {class:'badge'}, [c, ' ']);
      const x = el('button', {}, ['×']); x.addEventListener('click', ()=>{ list.splice(idx,1); renderLabels(); renderPreview(); });
      chip.append(x); chips.append(chip);
    }
    container.prepend(chips);
  }
  function renderLabels(){
    // title + price
    optionsForColumns($('#titleCol')); $('#titleCol').value = config.primary.titleCol || '';
    optionsForColumns($('#priceCol'), true); $('#priceCol').value = config.primary.priceCol || '';
    $('#titleCol').onchange = e => { config.primary.titleCol = e.target.value || undefined; renderPreview(); };
    $('#priceCol').onchange = e => { config.primary.priceCol = e.target.value || undefined; renderPreview(); };
    // subtitles, badges, secondary
    renderListPicker($('#subtitleWrap'), config.primary.subtitleCols);
    renderListPicker($('#badgeWrap'), config.primary.badgeCols);
    renderListPicker($('#secondaryWrap'), config.secondaryCols);
    $('#addSubtitle').onclick = () => {}; // handled inside renderListPicker
    $('#addBadge').onclick = () => {};
    $('#addSecondary').onclick = () => {};
    // nav controls
    optionsForColumns($('#navCol'), true); $('#navCol').value = (config.nav && config.nav.column) || '';
    const navAll = $('#navAll'); if (navAll) navAll.checked = !config.nav || config.nav.showAll !== false;
    $('#navCol').onchange = e => { config.nav = config.nav || {}; config.nav.column = e.target.value || undefined; activeNavValue = null; renderPreview(); };
    if (navAll) navAll.onchange = e => { config.nav = config.nav || {}; config.nav.showAll = !!e.target.checked; buildNavBar(); };
  };
    $('#priceCol').onchange = e => { config.primary.priceCol = e.target.value || undefined; renderPreview(); };
    // subtitles, badges, secondary
    renderListPicker($('#subtitleWrap'), config.primary.subtitleCols);
    renderListPicker($('#badgeWrap'), config.primary.badgeCols);
    renderListPicker($('#secondaryWrap'), config.secondaryCols);
    $('#addSubtitle').onclick = () => {}; // handled inside renderListPicker
    $('#addBadge').onclick = () => {};
    $('#addSecondary').onclick = () => {};
  }

  // ---------- Facets panel ----------
  function inferFacetMeta(col){
    const vals = rows.map(r => String(r[col]||''));
    const nums = rows.map(r => coerceNumber(r[col])).filter(n=>n!=null);
    return {
      options: uniq(vals),
      min: nums.length? Math.min(...nums):0,
      max: nums.length? Math.max(...nums):100
    };
  }
  function facetCard(f){
    const card = el('div', {class:'card'});
    const header = el('div', {class:'row'}, [el('strong',{},[`Facet: ${f.label}`])]);
    const grid = el('div', {class:'grid g3'});

    // Column select
    const colSel = el('select'); optionsForColumns(colSel); colSel.value = f.col || columns[0] || '';
    colSel.onchange = e => { f.col = e.target.value; renderFacets(); renderPreview(); };

    // Label input
    const labelIn = el('input', {type:'text', value:f.label || 'Facet'});
    labelIn.oninput = e => { f.label = e.target.value; };

    // Type select
    const typeSel = el('select');
    [['multi','Multi-select'],['range','Range'],['tokens','Tokens'],['text','Contains'],['boolean','Boolean']].forEach(([v,t])=>{
      typeSel.append(el('option',{value:v},[t]));
    });
    typeSel.value = f.type || 'multi';
    typeSel.onchange = e => { f.type = e.target.value; renderFacets(); renderPreview(); };

    grid.append(
      el('div',{},[el('label',{},['Column']), colSel]),
      el('div',{},[el('label',{},['Display label']), labelIn]),
      el('div',{},[el('label',{},['Facet type']), typeSel])
    );

    card.append(header, grid);

    if (f.type === 'tokens') {
      const tok = el('input',{type:'text', value: f.tokenizeBy || ','});
      tok.oninput = e => { f.tokenizeBy = e.target.value || ','; renderPreview(); };
      card.append(el('div',{},[el('label',{},['Token delimiter']), tok]));
    }

    const remove = el('button',{},['Remove']);
    remove.addEventListener('click', ()=>{
      const i = config.facets.findIndex(x => x===f); if(i>=0) config.facets.splice(i,1); renderFacets(); renderPreview();
    });
    card.append(el('div',{class:'sep'}));
    card.append(remove);
    return card;
  }
  function renderFacets(){
    const list = $('#facetList'); list.innerHTML = '';
    for (const f of config.facets) list.append(facetCard(f));
  }
  $('#addFacet').addEventListener('click', ()=>{
    config.facets.push({ id: crypto.randomUUID(), col: columns[0]||'', label:'Facet', type:'multi' });
    renderFacets();
  });

  // ---------- Preview panel ----------
  function buildNavBar(){
    const bar = $('#navBar'); if (!bar) return; bar.innerHTML='';
    if (!config.nav || !config.nav.column) return;
    const values = uniq(rows.map(r=>String(r[config.nav.column]||'')));
    if (config.nav.showAll){
      const btnAll = el('button', {class:'tab', 'aria-selected': activeNavValue? 'false':'true'}, ['All']);
      btnAll.onclick = () => { activeNavValue = null; renderResults(); buildNavBar(); };
      bar.append(btnAll);
    }
    for (const v of values) {
      const btn = el('button', {class:'tab', 'aria-selected': String(activeNavValue)===v ? 'true':'false'}, [v]);
      btn.onclick = () => { activeNavValue = v; renderResults(); buildNavBar(); };
      bar.append(btn);
    }
  }

  function buildFacetControls(){
    const wrap = $('#filters'); wrap.innerHTML = '';
    for (const f of config.facets) {
      const block = el('div', {class:'card'});
      block.append(el('div',{},[el('strong',{},[f.label||f.col])]))
      const meta = inferFacetMeta(f.col);
      if (f.type === 'range') {
        const min = meta.min, max = meta.max;
        if (!Array.isArray(facetState[f.id])) facetState[f.id] = [min, max];
        const lo = el('input',{type:'number', value: facetState[f.id][0]});
        const hi = el('input',{type:'number', value: facetState[f.id][1]});
        lo.oninput = ()=>{ facetState[f.id] = [Number(lo.value), Number(hi.value)]; renderResults(); };
        hi.oninput = ()=>{ facetState[f.id] = [Number(lo.value), Number(hi.value)]; renderResults(); };
        block.append(el('div',{class:'grid g2'},[
          el('div',{},[el('label',{},['Min']), lo]),
          el('div',{},[el('label',{},['Max']), hi])
        ]));
      } else if (f.type === 'tokens' || f.type === 'multi') {
        const chosen = new Set(facetState[f.id] || []);
        for (const opt of (f.type==='tokens' ? tokenSet(rows.map(r=>String(r[f.col]||'')), f.tokenizeBy||',') : meta.options)) {
          const id = `${f.id}:${opt}`;
          const cb = el('input',{type:'checkbox', id}); cb.checked = chosen.has(opt);
          cb.onchange = ()=>{ if(cb.checked) chosen.add(opt); else chosen.delete(opt); facetState[f.id] = Array.from(chosen); renderResults(); };
          const lab = el('label',{for:id},[opt]);
          const row = el('div',{class:'opt'},[cb, lab]);
          block.append(row);
        }
      } else if (f.type === 'text') {
        const t = el('input',{type:'text', value: facetState[f.id] || ''});
        t.oninput = ()=>{ facetState[f.id] = t.value; renderResults(); };
        block.append(t);
      } else if (f.type === 'boolean') {
        const options = ['true','false'];
        const chosen = new Set(facetState[f.id] || []);
        for (const opt of options) {
          const id = `${f.id}:${opt}`;
          const cb = el('input',{type:'checkbox', id}); cb.checked = chosen.has(opt);
          cb.onchange = ()=>{ if(cb.checked) chosen.add(opt); else chosen.delete(opt); facetState[f.id] = Array.from(chosen); renderResults(); };
          const lab = el('label',{for:id},[opt==='true'?'Yes':'No']);
          block.append(el('div',{class:'opt'},[cb, lab]));
        }
      }
      wrap.append(block);
    }
  }
  function tokenSet(values, delim){
    const out = new Set();
    for (const v of values) for (const t of v.split(delim).map(x=>x.trim()).filter(Boolean)) out.add(t);
    return Array.from(out).sort((a,b)=>a.localeCompare(b));
  }
  function renderResults(){
    const q = $('#q').value.trim().toLowerCase();
    const list = $('#results'); list.innerHTML = '';
    let filtered = rows.filter(r => {
      const title = config.primary.titleCol ? String(r[config.primary.titleCol]||'') : '';
      const fields = [title, ...config.primary.subtitleCols.map(c=>String(r[c]||'')), ...config.primary.badgeCols.map(c=>String(r[c]||'')), ...config.secondaryCols.map(c=>String(r[c]||''))];
      if (q && !fields.join(' ').toLowerCase().includes(q)) return false;
      // nav filter
      if (config.nav && config.nav.column && activeNavValue && String(r[config.nav.column]) !== String(activeNavValue)) return false;
      // facets
      for (const f of config.facets) {
        const val = r[f.col];
        if (f.type === 'range') {
          const [lo,hi] = facetState[f.id] || [-Infinity, Infinity];
          const n = coerceNumber(val); if (n==null || n<lo || n>hi) return false;
        } else if (f.type === 'text') {
          const needle = (facetState[f.id]||'').toLowerCase(); if (needle && !String(val||'').toLowerCase().includes(needle)) return false;
        } else if (f.type === 'tokens') {
          const need = new Set(facetState[f.id]||[]); if (need.size){
            const tokens = String(val||'').split(f.tokenizeBy||',').map(x=>x.trim().toLowerCase()).filter(Boolean);
            for (const n of need) if (!tokens.includes(String(n).toLowerCase())) return false;
          }
        } else if (f.type === 'multi') {
          const need = new Set(facetState[f.id]||[]); if (need.size && !need.has(String(val))) return false;
        } else if (f.type === 'boolean') {
          const need = facetState[f.id]||[]; if (need.length){
            const norm = String(val||'').toLowerCase(); const truth = (norm==='true'||norm==='yes') ? 'true':'false';
            if (!need.includes(truth)) return false;
          }
        }
      }
      return true;
    });

    $('#count').textContent = `${filtered.length} of ${rows.length} coffees`;

    for (const r of filtered) {
      const card = el('div',{class:'card'});
      const title = config.primary.titleCol ? r[config.primary.titleCol] : '(Untitled)';
      card.append(el('div',{class:'row', style:'justify-content:space-between'},[
        el('div',{},[
          el('div',{style:'font-weight:600'},[title]),
          el('div',{class:'muted'},[config.primary.subtitleCols.map((c,i)=>`${r[c]}`).filter(Boolean).join(' • ') || ''])
        ]),
        config.primary.priceCol ? el('div',{style:'font-weight:600'},[`$${Number(r[config.primary.priceCol]).toFixed? Number(r[config.primary.priceCol]).toFixed(2): r[config.primary.priceCol]}`]) : el('span')
      ]));
      const badges = config.primary.badgeCols.flatMap(c => String(r[c]||'').split(/[,;]/).map(x=>x.trim()).filter(Boolean));
      const bag = el('div',{class:'row'}); for (const b of badges) bag.append(el('span',{class:'badge'},[b])); card.append(bag);
      if (config.secondaryCols.length){
        const kv = el('div',{class:'kv'});
        for (const c of config.secondaryCols) { kv.append(el('div',{class:'muted'},[c]), el('div',{},[String(r[c]||'')])); }
        card.append(kv);
      }
      list.append(card);
    }
  } else if (f.type === 'text') {
          const needle = (facetState[f.id]||'').toLowerCase(); if (needle && !String(val||'').toLowerCase().includes(needle)) return false;
        } else if (f.type === 'tokens') {
          const need = new Set(facetState[f.id]||[]); if (need.size){
            const tokens = String(val||'').split(f.tokenizeBy||',').map(x=>x.trim().toLowerCase()).filter(Boolean);
            for (const n of need) if (!tokens.includes(String(n).toLowerCase())) return false;
          }
        } else if (f.type === 'multi') {
          const need = new Set(facetState[f.id]||[]); if (need.size && !need.has(String(val))) return false;
        } else if (f.type === 'boolean') {
          const need = facetState[f.id]||[]; if (need.length){
            const norm = String(val||'').toLowerCase(); const truth = (norm==='true'||norm==='yes') ? 'true':'false';
            if (!need.includes(truth)) return false;
          }
        }
      }
      return true;
    });

    $('#count').textContent = `${filtered.length} of ${rows.length} coffees`;

    for (const r of filtered) {
      const card = el('div',{class:'card'});
      const title = config.primary.titleCol ? r[config.primary.titleCol] : '(Untitled)';
      card.append(el('div',{class:'row', style:'justify-content:space-between'},[
        el('div',{},[
          el('div',{style:'font-weight:600'},[title]),
          el('div',{class:'muted'},[config.primary.subtitleCols.map((c,i)=>`${r[c]}`).filter(Boolean).join(' • ') || ''])
        ]),
        config.primary.priceCol ? el('div',{style:'font-weight:600'},[`$${Number(r[config.primary.priceCol]).toFixed? Number(r[config.primary.priceCol]).toFixed(2): r[config.primary.priceCol]}`]) : el('span')
      ]));
      const badges = config.primary.badgeCols.flatMap(c => String(r[c]||'').split(/[,;]/).map(x=>x.trim()).filter(Boolean));
      const bag = el('div',{class:'row'}); for (const b of badges) bag.append(el('span',{class:'badge'},[b])); card.append(bag);
      if (config.secondaryCols.length){
        const kv = el('div',{class:'kv'});
        for (const c of config.secondaryCols) { kv.append(el('div',{class:'muted'},[c]), el('div',{},[String(r[c]||'')])); }
        card.append(kv);
      }
      list.append(card);
    }
  }
  function renderPreview(){ buildFacetControls(); buildNavBar(); renderResults(); }
  $('#q').addEventListener('input', renderResults);
  $('#clear').addEventListener('click', ()=>{ Object.keys(facetState).forEach(k=>delete facetState[k]); $('#q').value=''; renderPreview(); });

  // Mermaid export
  function makeMermaid(){
    const lines = [];
    lines.push('flowchart TD');
    lines.push('  A[Coffee Faceted Search]');
    if (config.nav && config.nav.column) lines.push(`  A --> B[Primary Nav: ${config.nav.column}]`);
    lines.push('  A --> C[Primary Search]');
    if (config.facets.length){
      lines.push('  A --> D[Facets]');
      config.facets.forEach((f,i)=>{ lines.push(`  D --> D${i}[${f.label||f.col} (${f.type})]`); });
    }
    lines.push('  A --> E[Result Card]');
    if (config.primary.titleCol) lines.push(`  E --> E1[Title: ${config.primary.titleCol}]`);
    if (config.primary.subtitleCols.length) lines.push(`  E --> E2[Subtitles: ${config.primary.subtitleCols.join(' | ')}]`);
    if (config.primary.badgeCols.length) lines.push(`  E --> E3[Badges: ${config.primary.badgeCols.join(' | ')}]`);
    if (config.secondaryCols.length) lines.push(`  E --> E4[Secondary: ${config.secondaryCols.join(' | ')}]`);
    return lines.join('\n');
  }
  const exportBtn = document.getElementById('exportMermaid');
  if (exportBtn){
    exportBtn.addEventListener('click', ()=>{
      const code = makeMermaid();
      const ta = document.getElementById('mermaidText');
      const wrap = document.getElementById('mermaidWrap');
      if (ta && wrap){ ta.value = code; wrap.style.display='block'; }
    });
  }
  const hideBtn = document.getElementById('hideMermaid'); if (hideBtn) hideBtn.addEventListener('click', ()=>{ document.getElementById('mermaidWrap').style.display='none'; });
  const dlBtn = document.getElementById('downloadMermaid'); if (dlBtn) dlBtn.addEventListener('click', ()=>{
    const blob = new Blob([document.getElementById('mermaidText').value], {type:'text/markdown'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='coffee-ia-mermaid.md'; a.click(); URL.revokeObjectURL(url);
  });

  // Load sample immediately for convenience
  $('#load').click();
  const clearBtn = document.getElementById('clear'); if (clearBtn) clearBtn.addEventListener('click', ()=>{ activeNavValue = null; buildNavBar(); });
})();
</script>
</body>
</html>
