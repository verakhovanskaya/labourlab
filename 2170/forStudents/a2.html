<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Faceted Search Designer — Minimal, Single File</title>
<style>
  :root { --bg:#0b0f14; --card:#121821; --ink:#eef3f8; --muted:#9fb0c4; --line:#223042; --chip:#1a2330; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header, .container{max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{font-size:18px;margin:0}
  .btn{background:#1e2937;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding:0 16px}
  .tab{padding:8px 10px;border:1px solid var(--line);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#0e141c;color:var(--muted);cursor:pointer}
  .tab.active{background:var(--card);color:var(--ink)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px}
  .card .body{padding:12px}
  textarea, input, select{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0e141c;color:var(--ink)}
  label{display:block;margin:6px 0 6px;color:var(--muted)}
  .side{position:sticky;top:12px;align-self:start}
  .facet{border:1px solid var(--line);border-radius:10px;padding:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;background:#0e141c;border:1px solid var(--line)}
  .muted{color:var(--muted)}
  .topnav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
</style>
</head>
<body>
<header>
  <div>
    <h1>Faceted Search Designer (Minimal)</h1>
    <div class="muted" style="font-size:12px">Single HTML file. Paste CSV → map labels & nav → add facets → preview. No localStorage.</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="loadSample" class="btn">Load sample</button>
  </div>
</header>

<div class="tabs">
  <button class="tab active" data-tab="data">1. Data</button>
  <button class="tab" data-tab="labels">2. Labels & Nav</button>
  <button class="tab" data-tab="facets">3. Facets</button>
  <button class="tab" data-tab="preview">4. Preview</button>
</div>

<div class="container">
  <!-- DATA TAB -->
  <section id="tab-data">
    <div class="card"><div class="body">
      <label for="csv">CSV (first row = headers)</label>
      <textarea id="csv" rows="14"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="parseCsv" class="btn">Load</button>
        <span class="muted" id="detected">Detected columns: none</span>
      </div>
    </div></div>
  </section>

  <!-- LABELS TAB -->
  <section id="tab-labels" class="hidden">
    <div class="card"><div class="body grid two">
      <div>
        <label>Primary title</label>
        <select id="titleCol"></select>
      </div>
      <div>
        <label>Top navigation column (optional)</label>
        <select id="navCol"></select>
      </div>
      <div>
        <label>Subtitle (optional)</label>
        <select id="subtitleCol"></select>
      </div>
      <div>
        <label>Price (optional)</label>
        <select id="priceCol"></select>
      </div>
    </div></div>
  </section>

  <!-- FACETS TAB -->
  <section id="tab-facets" class="hidden">
    <div class="card"><div class="body grid two">
      <div>
        <label>Add facet (categorical/text)</label>
        <div class="grid two">
          <select id="facetCol"></select>
          <button id="addFacet" class="btn">Add</button>
        </div>
      </div>
      <div>
        <label>Add numeric facet (range)</label>
        <div class="grid two">
          <select id="rangeCol"></select>
          <button id="addRange" class="btn">Add</button>
        </div>
      </div>
    </div></div>
    <div id="facetList" class="grid" style="margin-top:8px"></div>
  </section>

  <!-- PREVIEW TAB -->
  <section id="tab-preview" class="hidden">
    <div class="grid two">
      <aside class="card side"><div class="body">
        <label>Search</label>
        <input id="query" placeholder="Search across title + subtitle" />
        <div id="facetFilters" class="grid" style="margin-top:12px"></div>
        <button id="clearAll" class="btn" style="margin-top:8px">Clear all</button>
      </div></aside>
      <div>
        <div id="topNav" class="topnav"></div>
        <div class="muted" style="margin:4px 0"><span id="count">0</span> results</div>
        <div id="resultList" class="list"></div>
      </div>
    </div>
  </section>
</div>

<script>
// ---------- State ----------
let rows = []; let columns = [];
let config = {
  titleCol: '', subtitleCol: '', priceCol: '', navCol: '',
  facets: [] // {id, type:'categorical'|'text'|'range', col, tokens?:string}
};
let facetState = {}; // id -> selection
let activeNav = null;

// ---------- Sample CSV ----------
const SAMPLE = `Coffee ID,Name,Origin (Country),Altitude (m),Cultivar/Varietal,Processing Method,Harvest Year,Certification,Flavor Profile,Acidity,Roast Level,Recommended Brewing Method,Recommended Brewing Method 2,Size,Availability,Price
101,El Paraiso Washed,Colombia,1800,Caturra,Washed,2024,Organic,"chocolate, citrus",Medium,Medium,Pour-over,Drip,250g,In stock,18.50
102,Nyeri PB,Kenya,1900,"SL28; SL34",Washed,2024,,"blackcurrant, grapefruit",High,Light,Pour-over,Aeropress,340g,In stock,22.00
103,Ethiopia Guji Natural,Ethiopia,2100,Heirloom,Natural,2023,Fairtrade,"blueberry, jasmine",High,Light,Pour-over,Espresso,250g,Pre-order,19.00
104,Sidamo Decaf,Ethiopia,1800,Bourbon,Swiss Water Decaf,2023,Organic,"cocoa, almond",Low,Medium,Drip,"French Press",340g,In stock,17.00
105,Sul de Minas Pulped Natural,Brazil,1200,Yellow Catuai,Pulped Natural,2024,Rainforest,"peanut, caramel",Low,Medium-Dark,Espresso,Drip,1000g,In stock,25.00
106,Peaberry Peñas Blancas,Costa Rica,1600,Typica,White Honey,2024,,"stone fruit, vanilla",Medium,Light,Pour-over,"Cold Brew",250g,In stock,16.50
107,Sumatra Gayo,Indonesia,1400,Catimor,Wet-Hulled,2023,,"earthy, cedar",Low,Dark,Espresso,"French Press",340g,In stock,20.00
108,Antigua SHB,Guatemala,1700,Bourbon,Washed,2024,,"toffee, apple",Medium,Medium,Pour-over,Drip,250g,Out of stock,15.50`;

// ---------- CSV Parser (minimal) ----------
function parseCSV(text){
  const out=[]; let row=[],cell='',q=false; for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(q){ if(ch==='"'){ if(text[i+1]==='"'){cell+='"'; i++;} else {q=false;} } else cell+=ch; continue; }
    if(ch==='"'){ q=true; continue; }
    if(ch===','){ row.push(cell); cell=''; continue; }
    if(ch==='
' || ch==='
'){ if(ch==='
'&&text[i+1]==='
') i++; row.push(cell); out.push(row); row=[]; cell=''; continue; }
    cell+=ch;
  }
  row.push(cell); out.push(row);
  const header = out[0].map(h=>h.trim());
  const data = out.slice(1).filter(r=>r.some(x=>String(x).trim())).map(r=>{ const o={}; header.forEach((h,j)=>o[h]= (r[j]??'').trim()); return o; });
  return {columns:header, rows:data};
}

// ---------- Helpers ----------
const $ = s=>document.querySelector(s);
function populate(sel, arr, includeBlank=false){ sel.innerHTML=''; if(includeBlank) sel.append(new Option('','')); arr.forEach(c=> sel.append(new Option(c,c))); }
function uniq(a){ return Array.from(new Set(a.filter(Boolean).map(String))).sort((x,y)=>x.localeCompare(y)); }
function num(v){ const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return Number.isFinite(n)?n:null; }

// ---------- Tabs ----------
document.querySelectorAll('.tab').forEach(b=> b.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const id=b.dataset.tab; ['data','labels','facets','preview'].forEach(t=>{
    const sec=$('#tab-'+t); sec.classList.toggle('hidden', t!==id);
  });
  if(id==='preview') renderPreview();
  if(id==='labels') renderLabelsUI();
  if(id==='facets') renderFacetsUI();
});

// ---------- Data actions ----------
$('#loadSample').onclick = ()=>{ $('#csv').value = SAMPLE; $('#parseCsv').click(); };
$('#parseCsv').onclick = ()=>{
  const txt = $('#csv').value.trim(); if(!txt){ alert('Paste CSV first.'); return; }
  const parsed = parseCSV(txt); rows = parsed.rows; columns = parsed.columns;
  $('#detected').textContent = columns.length? ('Detected columns: ' + columns.join(', ')) : 'Detected columns: none';
  // best-effort defaults
  config.titleCol = columns.includes('Name') ? 'Name' : (columns[0]||'');
  config.subtitleCol = columns.includes('Origin (Country)') ? 'Origin (Country)' : '';
  config.priceCol = columns.includes('Price') ? 'Price' : '';
  config.navCol = columns.includes('Roast Level') ? 'Roast Level' : '';
  facetState = {}; config.facets = [];
  renderLabelsUI(); renderFacetsUI();
  alert('CSV loaded. Go to Labels & Nav.');
};

// ---------- Labels UI ----------
function renderLabelsUI(){
  populate($('#titleCol'), columns);
  populate($('#subtitleCol'), columns, true);
  populate($('#priceCol'), columns, true);
  populate($('#navCol'), columns, true);
  $('#titleCol').value = config.titleCol||'';
  $('#subtitleCol').value = config.subtitleCol||'';
  $('#priceCol').value = config.priceCol||'';
  $('#navCol').value = config.navCol||'';
}
$('#titleCol').onchange = e=>{ config.titleCol = e.target.value; };
$('#subtitleCol').onchange = e=>{ config.subtitleCol = e.target.value; };
$('#priceCol').onchange = e=>{ config.priceCol = e.target.value; };
$('#navCol').onchange = e=>{ config.navCol = e.target.value; activeNav = null; };

// ---------- Facets UI ----------
function renderFacetsUI(){ populate($('#facetCol'), columns); populate($('#rangeCol'), columns); buildFacetList(); }
$('#addFacet').onclick = ()=>{ const c=$('#facetCol').value; if(!c) return; config.facets.push({id:crypto.randomUUID(), type:'categorical', col:c}); buildFacetList(); };
$('#addRange').onclick = ()=>{ const c=$('#rangeCol').value; if(!c) return; config.facets.push({id:crypto.randomUUID(), type:'range', col:c}); buildFacetList(); };
function buildFacetList(){
  const host = $('#facetList'); host.innerHTML='';
  config.facets.forEach(f=>{
    const box = document.createElement('div'); box.className='card';
    const body = document.createElement('div'); body.className='body';
    const h = document.createElement('div'); h.textContent = `${f.type.toUpperCase()} • ${f.col}`; h.className='muted'; body.append(h);
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Remove'; del.onclick=()=>{ config.facets = config.facets.filter(x=>x.id!==f.id); buildFacetList(); };
    body.append(del); box.append(body); host.append(box);
  });
}

// ---------- Preview ----------
$('#query').oninput = ()=> renderResults();
$('#clearAll').onclick = ()=>{ $('#query').value=''; activeNav=null; facetState={}; renderPreview(); };

function buildTopNav(){
  const host = $('#topNav'); host.innerHTML='';
  if(!config.navCol) return;
  const vals = uniq(rows.map(r=> String(r[config.navCol]||'')));
  const all = document.createElement('button'); all.className='btn ghost'; all.textContent='All';
  all.disabled = (activeNav===null);
  all.onclick=()=>{ activeNav=null; renderResults(); };
  host.append(all);
  vals.forEach(v=>{
    const b = document.createElement('button'); b.className='btn'; b.textContent=v||'(blank)';
    b.disabled = (activeNav===v);
    b.onclick=()=>{ activeNav=v; renderResults(); };
    host.append(b);
  });
}

function renderFacetFilters(){
  const host = $('#facetFilters'); host.innerHTML='';
  config.facets.forEach(f=>{
    const wrap = document.createElement('div'); wrap.className='facet';
    const title = document.createElement('div'); title.className='muted'; title.textContent = f.col; wrap.append(title);
    if(f.type==='categorical'){
      const opts = uniq(rows.map(r=> String(r[f.col]||'')));
      const sel = document.createElement('select'); sel.innerHTML = '<option value="">(any)</option>' + opts.map(o=>`<option>${o}</option>`).join('');
      sel.value = facetState[f.id] || '';
      sel.onchange = ()=>{ facetState[f.id]= sel.value || ''; renderResults(); };
      wrap.append(sel);
    }
    if(f.type==='range'){
      const nums = rows.map(r=> num(r[f.col])).filter(v=>v!==null);
      const min = nums.length? Math.min(...nums):0; const max = nums.length? Math.max(...nums):100;
      if(!Array.isArray(facetState[f.id])) facetState[f.id] = [min,max];
      const lo = document.createElement('input'); lo.type='number'; lo.value=facetState[f.id][0];
      const hi = document.createElement('input'); hi.type='number'; hi.value=facetState[f.id][1];
      lo.onchange=()=>{ facetState[f.id][0]=Number(lo.value); renderResults(); };
      hi.onchange=()=>{ facetState[f.id][1]=Number(hi.value); renderResults(); };
      wrap.append(lo, hi);
    }
    host.append(wrap);
  });
}

function rowMatches(r){
  const q = $('#query').value.toLowerCase().trim();
  const title = config.titleCol ? String(r[config.titleCol]||'') : '';
  const subtitle = config.subtitleCol ? String(r[config.subtitleCol]||'') : '';
  if(q && !(title+' '+subtitle).toLowerCase().includes(q)) return false;
  if(config.navCol && activeNav!==null && String(r[config.navCol])!==String(activeNav)) return false;
  for(const f of config.facets){
    const val = r[f.col];
    if(f.type==='categorical'){ const need = facetState[f.id]||''; if(need && String(val)!==String(need)) return false; }
    if(f.type==='range'){
      const [lo,hi]=facetState[f.id]||[-Infinity,Infinity]; const n=num(val); if(n===null||n<lo||n>hi) return false;
    }
  }
  return true;
}

function renderResults(){
  const host = $('#resultList'); host.innerHTML='';
  const filtered = rows.filter(rowMatches);
  $('#count').textContent = `${filtered.length} of ${rows.length}`;
  filtered.forEach((r,i)=>{
    const card = document.createElement('div'); card.className='card';
    const body = document.createElement('div'); body.className='body';
    const title = config.titleCol? r[config.titleCol] : `Item #${i+1}`;
    body.append(Object.assign(document.createElement('div'), {textContent:title}));
    if(config.subtitleCol){ body.append(Object.assign(document.createElement('div'), {className:'muted', textContent:String(r[config.subtitleCol]||'')})); }
    if(config.priceCol){ const p = r[config.priceCol]; body.append(Object.assign(document.createElement('div'), {textContent: (Number(p)===Number(p))? ('$'+Number(p).toFixed(2)) : String(p)})); }
    card.append(body); host.append(card);
  });
}

function renderPreview(){ buildTopNav(); renderFacetFilters(); renderResults(); }

// ---------- Boot ----------
// Seed textarea and parse immediately so everything works out-of-the-box
$('#csv').value = SAMPLE; $('#parseCsv').click();
</script>
</body>
</html>
